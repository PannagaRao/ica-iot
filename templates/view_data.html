<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Data View</title>

    <!-- Bootstrap & DataTables CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='jquery.dataTables.min.css') }}">

    <style>
        tr td {
            text-align: center !important;
        }

        .fw-bold {
            font-weight: 600 !important;
        }

        .btn-outline-secondary {
            background-color: white;
            border-color: #6c757d;
            color: #070808;
            font-weight: 700 !important;
        }

        .btn-outline-secondary:hover {
            background-color: #e9ecef;
            border-color: #6c757d;
            color: #343a40;
        }

        /* spinner */
        .spinner-container {
            display: none;
            align-items: center;
            justify-content: center;
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: rgba(0, 0, 0, .35);
        }

        .spinner-container.show {
            display: flex;
        }

        .loader {
            border: 16px solid #f3f3f3;
            border-radius: 50%;
            border-top: 16px solid #3498db;
            width: 100px;
            height: 100px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0)
            }

            100% {
                transform: rotate(360deg)
            }
        }

        /* report-style header (shown only when batch filter active) */
        #reportHeader {
            display: none;
            border: 1px solid #e6e6e6;
            border-radius: 10px;
            padding: 14px 16px;
            margin-bottom: 16px;
        }

        #reportHeader.show {
            display: block;
        }

        #reportHeader .hdr-row {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        #reportHeader .col {
            flex: 1;
        }

        #reportHeader .center {
            flex: 0 0 180px;
            text-align: center;
        }

        #reportHeader .kv {
            display: flex;
            justify-content: space-between;
            margin: 2px 0;
        }

        #reportHeader .kv span:first-child {
            color: #666;
        }

        #reportHeader .kv span:last-child {
            font-weight: 600;
        }
    </style>
</head>

<body>
    <!-- Spinner -->
    <div class="spinner-container" id="page_spinner">
        <div class="loader"></div>
    </div>

    <div class="mx-5 px-5">
        <!-- Top row: logo + actions -->
        <div class="d-flex justify-content-between align-items-center my-3">
            <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" height="60">
            <div class="d-flex">
                <button class="btn btn-outline-secondary mx-1 fw-bold" id="print_data">Report Data</button>
                <button type="button" class="btn btn-outline-secondary mx-1 fw-bold" id="del_batch" data-toggle="modal"
                    data-target="#del_confirm_modal">Delete Batch</button>
                <button type="button" class="btn btn-outline-secondary mx-1 fw-bold" id="del_all" data-toggle="modal"
                    data-target="#del_confirm_modal">Delete All</button>
            </div>
        </div>

        <!-- Report-style header (hidden until a batch filter is applied and rows exist) -->
        <div id="reportHeader">
            <div class="hdr-row">
                <!-- LEFT: minimal (no model/project/serial/set rpm/time) -->
                <div class="col">
                    <div class="kv"><span>PROCESS PILOT</span><span>ICA</span></div>
                    <div class="kv"><span>User Name</span><span>ica@ica.com</span></div>
                    <div class="kv"><span>Batch</span><span id="hdr_batch"></span></div>
                </div>

                <!-- CENTER: logo -->
                <div class="center">
                    <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" style="height:60px; opacity:.9;">
                </div>

                <!-- RIGHT: like the report -->
                <div class="col">
                    <div class="kv"><span>Process Start Time</span><span id="hdr_start_time"></span></div>
                    <div class="kv"><span>Process End Time</span><span id="hdr_end_time"></span></div>
                    <div class="kv"><span>Date</span><span id="hdr_today"></span></div>
                    <div class="kv"><span>Interval</span><span id="hdr_interval">1</span></div>
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table id="myTable" class="table w-100">
                <thead>
                    <tr>
                        <th rowspan="2" class="text-center">SL.NO</th>
                        <th rowspan="2" class="text-center">Date &amp; Time</th>
                        <th rowspan="2" class="text-center">Batch ID</th>
                        <th class="text-center">Motor Speed</th>
                        <th class="text-center">Motor Current</th>
                        <th class="text-center">Motor Torque</th>
                        <th class="text-center">Motor Run Hour</th>
                        <th class="text-center">Product Temperature</th>
                        <th class="text-center">Tool Speed</th>
                        <th class="text-center">Actual Time</th>
                        <th class="text-center">Drive Trip</th>
                        <th class="text-center">Pressure Low</th>
                        <th class="text-center">Motor PTC</th>
                        <th class="text-center">Temp Sensor</th>
                    </tr>
                    <tr>
                        <th class="text-center">(RPM)</th>
                        <th class="text-center">(Amps)</th>
                        <th class="text-center">(%)</th>
                        <th class="text-center">(Hour)</th>
                        <th class="text-center">(Â°C)</th>
                        <th class="text-center">(RPM)</th>
                        <th class="text-center">(Second)</th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div class="modal" id="del_confirm_modal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Are you sure?</h5>
                    <button type="button" class="close" data-dismiss="modal"
                        aria-label="Close"><span>&times;</span></button>
                </div>
                <div class="modal-body">
                    <p>Do you really want to delete data?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">No</button>
                    <a href="/del_all" id="del_target"><button type="button" class="btn btn-primary">Yes</button></a>
                </div>
            </div>
        </div>
    </div>

    <!-- JS -->
    <script src="{{ url_for('static', filename='jquery-3.7.0.js') }}"></script>
    <script src="{{ url_for('static', filename='jquery.dataTables.min.js') }}"></script>
    <script src="{{ url_for('static', filename='bootstrap.min.js') }}"></script>
    <script src="{{ url_for('static', filename='popper.min.js') }}"></script>

    <script>
        function fmtNum(data, type) {
            if (type !== 'display') return data;
            var num = parseFloat(data);
            if (isNaN(num)) return '';
            var s = num.toFixed(2);
            while (s.endsWith('0')) s = s.slice(0, -1);
            if (s.endsWith('.')) s = s.slice(0, -1);
            return s;
        }
        function alarmBadge(val, type) {
            if (type !== 'display') return val;
            return (val && Number(val) !== 0) ? 'Active' : '';
        }
        function showSpinner(show) {
            document.getElementById('page_spinner').classList.toggle('show', !!show);
        }

        // fill today's date in header when shown
        function todayGB() {
            const n = new Date(); return n.toLocaleDateString('en-GB') + ' ' + n.toLocaleTimeString('en-GB');
        }

        $(document).ready(function () {
            // disable actions at start
            $("#print_data").prop("disabled", true);
            $("#del_batch").prop("disabled", true);

            // DataTable server-side
            var table = $('#myTable').DataTable({
                processing: true,
                serverSide: true,
                orderCellsTop: true,
                ajax: { url: "/filterData", type: "GET" },
                columns: [
                    { // SL.NO
                        data: 0,
                        render: function (data, type, row, meta) {
                            let p = $('#myTable').DataTable().page.info();
                            return (p.page * p.length) + meta.row + 1;
                        }
                    },
                    { // Date & Time -> timestamp [1]
                        data: 1,
                        render: function (data, type) {
                            if (type !== 'display') return data;
                            const d = new Date((data || '').replace(' ', 'T'));
                            return isNaN(d) ? (data || '') : d.toLocaleString('en-GB');
                        }
                    },
                    { data: 4 },           // Batch ID      [4]
                    { data: 12, render: fmtNum }, // Motor Speed  [12]
                    { data: 13, render: fmtNum }, // Motor Current[13]
                    { data: 14, render: fmtNum }, // Motor Torque [14]
                    { data: 15, render: fmtNum }, // Motor Run Hr [15]
                    { data: 16, render: fmtNum }, // Product Temp [16]
                    { data: 17, render: fmtNum }, // Tool Speed   [17]
                    { data: 19, render: fmtNum }, // Actual Time  [19]
                    { data: 7, render: alarmBadge }, // Drive Trip
                    { data: 8, render: alarmBadge }, // Pressure Low
                    { data: 9, render: alarmBadge }, // Motor PTC
                    { data: 10, render: alarmBadge }  // Temp Sensor
                ]
            });

            // Global search (used to filter by batch_id on backend)
            $('#myTable_filter input').on('keyup', function () {
                const q = this.value.trim();
                // when a batch id is entered, load many rows so we can compute start/end
                if (q.length) table.page.len(1000); else table.page.len(10);
                table.search(q).draw();
            });

            // After each draw, update report-style header visibility and content
            table.on('draw', function () {
                const q = $('#myTable_filter input').val().trim();
                const hasRows = table.data().length > 0;

                // toggle header
                const hdr = document.getElementById('reportHeader');
                hdr.classList.toggle('show', hasRows && q.length);

                $("#print_data").prop("disabled", !(hasRows && q.length));
                $("#del_batch").prop("disabled", !(hasRows && q.length));

                if (hasRows && q.length) {
                    const rows = table.rows().data(); // all rows currently loaded (we set page.len large)
                    const first = rows[0];
                    const last = rows[rows.length - 1];

                    // timestamp is at index [1]
                    const startStr = first[1];
                    const endStr = last[1];

                    // fill header
                    $("#hdr_batch").text(q);
                    $("#hdr_today").text(todayGB());

                    // pretty-print times
                    function toGB(ts) {
                        const d = new Date((ts || '').replace(' ', 'T'));
                        return isNaN(d) ? (ts || '') : d.toLocaleString('en-GB');
                    }
                    $("#hdr_start_time").text(toGB(startStr));
                    $("#hdr_end_time").text(toGB(endStr));
                } else {
                    $("#hdr_batch").text("");
                    $("#hdr_today").text("");
                    $("#hdr_start_time").text("");
                    $("#hdr_end_time").text("");
                }
            });

            // Report PDF
            $('#print_data').on('click', function (e) {
                e.preventDefault();
                const q = $('#myTable_filter input').val().trim();
                if (!q) return;
                let dt = new Date().toISOString().replace("T", "_").replaceAll(":", "-").split(".")[0];
                let filename = `report_data_${dt}.pdf`;
                let url = `/report?filename=${encodeURIComponent(filename)}&batch_id=${encodeURIComponent(q)}`;
                showSpinner(true);
                fetch(url, { method: 'GET' })
                    .then(r => r.blob())
                    .then(blob => {
                        const downloadUrl = URL.createObjectURL(new Blob([blob], { type: 'application/pdf' }));
                        const a = document.createElement("a");
                        a.href = downloadUrl; a.download = filename;
                        document.body.appendChild(a); a.click(); a.remove();
                        URL.revokeObjectURL(downloadUrl);
                    })
                    .finally(() => showSpinner(false));
            });

            // Delete Batch (pass ?batch_id=...)
            $('#del_batch').on('click', function () {
                const bid = $('#myTable_filter input').val().trim();
                $('#del_confirm_modal .modal-body p').text(
                    "Do you really want to delete Batch ID " + bid + " data?"
                );
                $('#del_target').attr("href", "/del_batch?batch_id=" + encodeURIComponent(bid));
            });

            // Delete All
            $('#del_all').on('click', function () {
                $('#del_confirm_modal .modal-body p').text("Do you really want to delete all data?");
                $('#del_target').attr("href", "/del_all");
            });
        });
    </script>
</body>

</html>